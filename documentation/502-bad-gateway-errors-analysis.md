# 502 Bad Gateway Errors - Comprehensive Analysis

**Date:** Generated by QA Analysis  
**Focus:** Potential sources of 502 Bad Gateway errors in SkillOnCall.ca

---

## Executive Summary

This report identifies **critical areas** where 502 Bad Gateway errors could occur due to timeout issues, server configuration problems, or resource-intensive operations.

---

## 🔴 CRITICAL ISSUES - 502 Error Sources

### 1. **File Upload Operations Without Timeout Protection**

**Impact:** High  
**Likelihood:** High for large files

#### A. Profile Photo Uploads

**Locations:**
- `app/Http/Controllers/Employee/OnboardingController.php:421`
- `app/Http/Controllers/Worker/OnboardingController.php:434`
- `app/Http/Controllers/Employee/EmployeeProfileController.php:132`
- `app/Http/Controllers/Worker/WorkerProfileController.php:133`

**Issue:** File uploads process synchronously without:
- Client-side file size validation before upload
- Server-side timeout handling
- Progress indication
- Chunked upload support

**Current Implementation:**
```php
$path = $file->store('profile_photos', 'public');
```

**Risk:** Large profile photos (10MB+) could:
- Exceed PHP `max_execution_time`
- Exceed PHP `upload_max_filesize`
- Exceed PHP `post_max_size`
- Cause Nginx/Apache timeout

**Recommendation:**
1. Add client-side validation (max 5MB)
2. Add server-side validation with clear error messages
3. Implement image compression before upload
4. Consider async processing via queues
5. Add upload progress tracking

---

#### B. Portfolio Photo Uploads (Multiple Files)

**Locations:**
- `app/Http/Controllers/Employee/EmployeeProfileController.php:280`
- `app/Http/Controllers/Worker/WorkerProfileController.php:301`
- `app/Http/Controllers/Employee/OnboardingController.php:719`
- `app/Http/Controllers/Worker/OnboardingController.php:791`

**Issue:** Multiple file uploads in a loop without batching or timeout protection.

**Current Implementation:**
```php
while ($request->hasFile("portfolio_photos.{$portfolioIndex}.file")) {
    $file = $request->file("portfolio_photos.{$portfolioIndex}.file");
    if ($file && $file->isValid()) {
        $path = $file->store('portfolio_photos', 'public');
        // ...
    }
    $portfolioIndex++;
}
```

**Risk:** Uploading 5+ portfolio photos simultaneously could:
- Exceed server timeout limits
- Cause memory exhaustion
- Block other requests
- Result in partial uploads (some succeed, others fail)

**Recommendation:**
1. Limit to 3-5 portfolio photos per request
2. Implement chunked uploads for multiple files
3. Process uploads asynchronously
4. Add batch size limits
5. Show progress indicator

---

#### C. Progress Tracker Screenshot Uploads

**Location:** `app/Http/Controllers/SkillOnCallProgressController.php`

**Multiple Issues:**
1. **File Uploads (Lines 102-108, 207-213):**
   - Accepts multiple screenshots up to 10MB each
   - No limit on total upload size
   - Processes synchronously

2. **Base64 Image Processing (Lines 266-310):**
   - Decodes base64 images in memory
   - No size validation before decoding
   - Could cause memory exhaustion

**Current Implementation:**
```php
// Base64 decoding - memory intensive
$imageData = base64_decode($imageData);
Storage::disk('public')->put($path, $imageData);
```

**Risk:** Large base64 images could:
- Exceed PHP memory limit
- Cause request timeouts
- Fail silently

**Recommendation:**
1. Validate base64 size before decoding
2. Set memory limit for image operations
3. Compress images after decoding
4. Add timeout error handling

---

### 2. **External API Calls - Resend Email Service**

**Location:** `app/Services/EmailService.php`

**Issue:** Synchronous email sending via Resend API without timeout handling.

**Current Implementation:**
```php
$result = Resend::emails()->send([...]);
```

**Files Affected:**
- Contact form submissions
- Newsletter subscriptions
- Subscription confirmations
- Welcome emails

**Risk:** If Resend API is:
- Slow to respond (>30 seconds)
- Temporarily unavailable
- Rate limiting requests

This could cause 502 errors because:
- No timeout configured on HTTP client (Guzzle)
- Requests wait indefinitely for response
- Blocks PHP-FPM processes
- No retry logic

**Recommendation:**
1. Add timeout to Resend client configuration
2. Move email sending to queues (already have queue system)
3. Implement retry logic with exponential backoff
4. Add fallback error handling
5. Log failures without blocking request

**Implementation:**
```php
// In config/services.php or EmailService
'timeout' => 10, // 10 second timeout
'connect_timeout' => 5, // 5 second connection timeout

// Or use queues
dispatch(new SendEmailJob($emailData));
```

---

### 3. **Heavy Database Queries**

**Locations:**
- `app/Services/Employer/EmployerDashboardService.php`
- `app/Services/Admin/AdminDashboardService.php`
- `app/Services/Employee/EmployeeDashboardService.php`
- Dashboard controllers

**Issue:** Complex queries without:
- Query timeout configuration
- Pagination limits
- Eager loading optimization
- Query result caching

**Examples:**

**EmployerDashboardService.php:**
```php
'totalApplications' => $employer->jobs()->withCount('applications')->get()->sum('applications_count'),
```

**EmployeeJobController.php:**
```php
$allActiveJobs = Job::query()->where('status', 'active')->get();
// Processes all jobs in memory for profession extraction
foreach ($allActiveJobs as $job) {
    // String manipulation on every job
}
```

**Risk:** With large datasets:
- Queries could take >30 seconds
- Memory exhaustion from large result sets
- Database connection timeout
- Blocks other requests

**Recommendation:**
1. Add query timeouts
2. Implement pagination for large datasets
3. Use eager loading to prevent N+1 queries
4. Cache expensive query results
5. Optimize with database indexes
6. Use chunking for large operations

**Implementation:**
```php
// In config/database.php
'options' => [
    PDO::ATTR_TIMEOUT => 10, // 10 second query timeout
],

// Or in queries
DB::connection()->setQueryTimeout(10);
```

---

### 4. **Inertia Middleware Processing**

**Location:** `app/Http/Middleware/HandleInertiaRequests.php`

**Issue:** Middleware performs multiple database queries and operations on every request.

**Current Implementation:**
- Loads worker profile (database query)
- Loads subscription (database query)
- Loads translations (file I/O)
- Multiple try-catch blocks with logging

**Risk:** If any of these operations timeout or fail:
- Request hangs
- Could cause 502 error
- No timeout protection

**Recommendation:**
1. Cache user profile data
2. Cache subscription data
3. Cache translations
4. Add timeout handling
5. Make operations fail gracefully

---

### 5. **Base64 Image Processing**

**Location:** `app/Http/Controllers/SkillOnCallProgressController.php:266-310`

**Critical Issue:** Base64 image decoding in memory without size checks.

**Problems:**
1. No validation of base64 string length
2. No memory limit check
3. No image size validation after decoding
4. Could decode 50MB+ images in memory

**Recommendation:**
```php
// Add before decoding
$base64Size = strlen($imageData);
$maxSize = 10 * 1024 * 1024; // 10MB

if ($base64Size > $maxSize) {
    return response()->json(['message' => 'Image too large'], 422);
}

// Check memory before decoding
$memoryLimit = ini_get('memory_limit');
$memoryUsage = memory_get_usage(true);
// Calculate if we have enough memory

// After decoding, validate actual image size
$decodedSize = strlen($imageData);
if ($decodedSize > $maxSize) {
    return response()->json(['message' => 'Decoded image too large'], 422);
}
```

---

### 6. **Server Configuration Issues**

#### PHP Configuration

**Required Settings:**
```ini
max_execution_time = 300  ; 5 minutes (increase from default 30s)
memory_limit = 256M       ; Increase if needed
upload_max_filesize = 10M
post_max_size = 12M       ; Must be > upload_max_filesize
max_input_time = 300
```

#### Nginx Configuration

**Required Settings:**
```nginx
client_max_body_size 12M;
fastcgi_read_timeout 300;
proxy_read_timeout 300;
send_timeout 300;
```

#### PHP-FPM Configuration

**Required Settings:**
```ini
request_terminate_timeout = 300
pm.max_children = 50
pm.start_servers = 5
pm.min_spare_servers = 5
pm.max_spare_servers = 10
```

---

### 7. **Missing Error Handling & Logging**

**Issue:** Many operations don't have proper timeout error handling.

**Missing:**
- Try-catch blocks around file operations
- Timeout exception handling
- Clear error messages for users
- Logging of timeout events

**Recommendation:**
```php
try {
    set_time_limit(300); // Extend timeout for this operation
    // ... operation
} catch (\Exception $e) {
    if ($e instanceof \Illuminate\Http\Exceptions\ThrottleRequestsException) {
        // Handle timeout
    }
    Log::error('Operation timeout', [
        'operation' => 'file_upload',
        'error' => $e->getMessage(),
    ]);
    return response()->json(['message' => 'Request timed out. Please try again.'], 504);
}
```

---

## 🟡 MEDIUM PRIORITY ISSUES

### 8. **No Queue Processing for Heavy Operations**

**Issue:** File uploads and email sending are synchronous.

**Recommendation:** Move to queues:
- Email sending → `SendEmailJob`
- Image processing → `ProcessImageJob`
- Large file uploads → `ProcessUploadJob`

**Benefits:**
- Non-blocking requests
- Better error handling
- Retry logic
- Better resource management

---

### 9. **No Request Timeout on Frontend**

**Issue:** Frontend fetch calls don't have timeout.

**Recommendation:**
```typescript
const controller = new AbortController();
const timeoutId = setTimeout(() => controller.abort(), 30000); // 30s timeout

try {
    const response = await fetch('/upload', {
        signal: controller.signal,
        // ... other options
    });
    clearTimeout(timeoutId);
} catch (error) {
    if (error.name === 'AbortError') {
        // Handle timeout
    }
}
```

---

## 📋 ACTION ITEMS CHECKLIST

### Immediate Actions (High Priority)
- [ ] Add client-side file size validation (max 5MB for profile, 10MB for portfolio)
- [ ] Add server-side timeout handling for file uploads
- [ ] Configure Resend API timeout (10 seconds)
- [ ] Move email sending to queues
- [ ] Add base64 image size validation
- [ ] Configure PHP/Nginx/PHP-FPM timeouts
- [ ] Add query timeouts to database configuration
- [ ] Add error logging for timeout events

### Short-term Actions (Medium Priority)
- [ ] Implement image compression before storage
- [ ] Add upload progress indicators
- [ ] Implement chunked uploads for large files
- [ ] Cache dashboard queries
- [ ] Optimize database queries with indexes
- [ ] Add request timeout on frontend fetch calls
- [ ] Implement retry logic for email sending

### Long-term Actions (Low Priority)
- [ ] Move all heavy operations to queues
- [ ] Implement CDN for file storage
- [ ] Add monitoring/alerting for timeout errors
- [ ] Implement request queuing for high traffic
- [ ] Add performance monitoring

---

## 🔍 TESTING RECOMMENDATIONS

1. **File Upload Testing:**
   - Test with 10MB+ files
   - Test multiple simultaneous uploads
   - Test on slow connections
   - Monitor server logs during uploads

2. **Email Service Testing:**
   - Test with Resend API offline
   - Test with slow API response
   - Monitor timeout errors
   - Verify queue processing

3. **Database Query Testing:**
   - Test with large datasets (1000+ records)
   - Monitor slow query logs
   - Test concurrent requests
   - Check memory usage

4. **Load Testing:**
   - Use tools like Apache JMeter or Artillery
   - Test concurrent file uploads
   - Test dashboard loading under load
   - Monitor server resources

---

## 📊 MONITORING RECOMMENDATIONS

Add monitoring for:
1. Request execution time
2. File upload sizes and durations
3. Database query times
4. External API response times
5. Memory usage
6. PHP-FPM process status
7. Nginx error logs

**Tools:**
- Laravel Telescope (for development)
- Laravel Debugbar (for debugging)
- Server monitoring (New Relic, DataDog, etc.)
- Error tracking (Sentry, Bugsnag)

---

## 📚 REFERENCES

- [Laravel File Uploads](https://laravel.com/docs/11.x/filesystem#file-uploads)
- [PHP Configuration](https://www.php.net/manual/en/ini.list.php)
- [Nginx Timeout Settings](https://nginx.org/en/docs/http/ngx_http_core_module.html)
- [PHP-FPM Configuration](https://www.php.net/manual/en/install.fpm.configuration.php)
- [Guzzle HTTP Client Timeouts](https://docs.guzzlephp.org/en/stable/request-options.html#timeout)

---

**Report Generated:** $(date)  
**Next Review:** After implementing high-priority fixes

