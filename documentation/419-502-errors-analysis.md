# 419 & 502 Errors - Comprehensive Analysis Report

**Date:** Generated by QA Analysis  
**Focus:** CSRF Token Mismatch (419) and Bad Gateway (502) Errors

---

## Executive Summary

This report identifies **multiple potential sources** of 419 (CSRF token mismatch) and 502 (Bad Gateway) errors throughout the SkillOnCall.ca application. The analysis reveals several critical areas requiring attention.

---

## 🔴 CRITICAL ISSUES - 419 Errors

### 1. **Missing VerifyCsrfToken Middleware Configuration**

**Location:** `app/Http/Middleware/VerifyCsrfToken.php` - **FILE DOES NOT EXIST**

**Issue:** Laravel 11 uses CSRF protection by default in the `web` middleware group, but there's no custom `VerifyCsrfToken` middleware to configure exceptions or handle edge cases.

**Impact:** High - Without custom middleware, you cannot:
- Exclude specific routes from CSRF protection if needed
- Customize CSRF token validation behavior
- Handle token refresh scenarios properly

**Recommendation:**
```php
// Create app/Http/Middleware/VerifyCsrfToken.php
<?php

namespace App\Http\Middleware;

use Illuminate\Foundation\Http\Middleware\VerifyCsrfToken as Middleware;

class VerifyCsrfToken extends Middleware
{
    /**
     * The URIs that should be excluded from CSRF verification.
     *
     * @var array<int, string>
     */
    protected $except = [
        // Add any API routes that should be excluded
        // Example: 'api/*' if you have external API integrations
    ];
}
```

Then register it in `bootstrap/app.php`:
```php
$middleware->validateCsrfTokens(except: [
    // Routes excluded from CSRF protection
]);
```

---

### 2. **Session Lifetime Too Short**

**Location:** `config/session.php:35`

**Issue:** Session lifetime is set to **120 minutes (2 hours)**. If users remain on pages longer than this, their session expires and CSRF tokens become invalid.

**Current Configuration:**
```php
'lifetime' => (int) env('SESSION_LIFETIME', 120),
```

**Impact:** High - Users experiencing 419 errors after 2 hours of inactivity, especially during long onboarding processes.

**Recommendation:**
- Increase session lifetime to at least 480 minutes (8 hours) for better user experience
- Or implement automatic session refresh on user activity
- Add client-side token refresh mechanism before expiration

---

### 3. **Fetch Calls Missing CSRF Token Headers**

**Location:** Multiple files using native `fetch()` instead of Inertia router

**Issues Found:**

#### A. GET Requests for API Endpoints (May need authentication)
These GET requests might still require CSRF tokens if they're modifying state or require session:

**Files:**
- `resources/js/pages/employer/jobs/create.tsx:95-106`
- `resources/js/components/profile/tabs/PersonalInfoTab.tsx:96`
- `resources/js/components/onboarding/employer/LocationStep.tsx:65`
- `resources/js/components/onboarding/LocationPreferencesStep.tsx:136`
- `resources/js/components/onboarding/PersonalInfoStep.tsx:67`

**Example:**
```typescript
const response = await fetch(`/employer/api/provinces/code/${data.province}/cities${searchParam}`);
// Missing: credentials, CSRF token headers
```

**Impact:** Medium - While GET requests typically don't require CSRF tokens, if these routes require authentication and session handling, they might fail.

**Recommendation:**
```typescript
const response = await fetch(`/employer/api/provinces/code/${data.province}/cities${searchParam}`, {
    method: 'GET',
    credentials: 'same-origin', // Ensure cookies are sent
    headers: {
        'X-Requested-With': 'XMLHttpRequest',
    }
});
```

#### B. POST/PUT Requests Missing Credentials
**Files:**
- `resources/js/pages/settings/profile.tsx:35-46` - Password update
- `resources/js/pages/welcome.tsx:64` - Contact form
- `resources/js/components/contact-modal.tsx:35` - Contact form

**Current Implementation:**
```typescript
await fetch('/settings/password', {
    method: 'PUT',
    headers: {
        'Content-Type': 'application/json',
        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '',
    },
    body: JSON.stringify({...}),
});
```

**Issue:** Missing `credentials: 'same-origin'` which is required for cookies (including session cookies) to be sent with cross-origin requests or in certain browser configurations.

**Impact:** High - Without credentials, session cookies won't be sent, causing CSRF validation to fail.

**Recommendation:**
```typescript
await fetch('/settings/password', {
    method: 'PUT',
    credentials: 'same-origin', // ADD THIS
    headers: {
        'Content-Type': 'application/json',
        'X-CSRF-TOKEN': document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '',
        'X-Requested-With': 'XMLHttpRequest', // ADD THIS
    },
    body: JSON.stringify({...}),
});
```

---

### 4. **Incomplete CSRF Error Handling in app.tsx**

**Location:** `resources/js/app.tsx:35-43`

**Issue:** The error handler doesn't actually refresh the token or reload the page automatically.

**Current Code:**
```typescript
router.on('error', (event) => {
    if (event.detail.errors && event.detail.errors.form === '419 Page Expired' || 
        event.detail.response?.status === 419) {
        console.warn('419 Page Expired - CSRF token may have expired. Attempting to refresh...');
        // Reload the page to get a fresh CSRF token
        // This will be handled by Inertia's default error handling
    }
});
```

**Impact:** Medium - Users get 419 errors but the app doesn't automatically recover.

**Recommendation:** Implement automatic page reload or token refresh:
```typescript
router.on('error', (event) => {
    if (event.detail.errors?.form === '419 Page Expired' || 
        event.detail.response?.status === 419) {
        console.warn('419 Page Expired - Reloading page to refresh CSRF token...');
        // Force reload after a short delay to show the error
        setTimeout(() => {
            window.location.reload();
        }, 1000);
    }
});
```

---

### 5. **Session Cookie Configuration Issues**

**Location:** `config/session.php`

**Potential Issues:**
- `SESSION_DOMAIN` not set - might cause cookie issues in subdomains
- `SESSION_SECURE_COOKIE` not explicitly set - might be `null` causing issues in production
- `SESSION_SAME_SITE` is `'lax'` which should be fine, but verify

**Recommendation:**
Ensure `.env` has proper session configuration:
```env
SESSION_DRIVER=database
SESSION_LIFETIME=480
SESSION_DOMAIN=null
SESSION_SECURE_COOKIE=false  # true for HTTPS in production
SESSION_SAME_SITE=lax
```

---

### 6. **Route Middleware Configuration**

**Location:** `bootstrap/app.php`

**Issue:** No explicit CSRF middleware validation configuration. Laravel 11 includes it by default in `web` middleware, but verify it's active.

**Verification Needed:**
- Check if `web` middleware group includes CSRF validation
- Verify routes are using the `web` middleware group where CSRF protection is needed

---

## 🟡 MEDIUM PRIORITY ISSUES

### 7. **Inertia FormData CSRF Token Handling**

**Location:** `resources/js/app.tsx:24-30`

**Current Implementation:**
```typescript
if (event.detail.visit.data instanceof FormData) {
    if (!event.detail.visit.data.has('_token')) {
        event.detail.visit.data.append('_token', csrfToken);
    }
}
```

**Potential Issue:** The token might be stale if the page has been open for a long time.

**Recommendation:** Add token freshness check or refresh mechanism.

---

### 8. **Employee/Worker Onboarding Long Forms**

**Location:** `resources/js/pages/employee/onboarding.tsx`

**Issue:** Long onboarding forms might take users longer than session lifetime, causing 419 errors when submitting final steps.

**Current Error Handling:**
```typescript:265:275:resources/js/pages/employee/onboarding.tsx
const isCsrfError = errors.form === '419 Page Expired' || 
                   errors.message === '419 Page Expired' ||
                   (typeof errors.form === 'string' && errors.form.includes('419'));

if (isCsrfError) {
    console.warn('CSRF token expired - reloading page to refresh token');
    window.location.reload();
    return;
}
```

This is good, but the reload loses form data. Consider:
1. Save form data to localStorage before reload
2. Restore form data after reload
3. Extend session on form activity

---

## 🔵 502 BAD GATEWAY ERROR SOURCES

### 9. **PHP Execution Timeout**

**Issue:** Long-running requests might hit PHP's `max_execution_time` limit, causing 502 errors.

**Files to Check:**
- File upload handlers (profile photos, portfolio items)
- Large data imports/exports
- Complex queries or reports

**Recommendation:**
- Check PHP configuration: `max_execution_time`
- For file uploads, consider async processing with queues
- Monitor slow queries and optimize

---

### 10. **Server Configuration Issues**

**Potential Causes:**
- Nginx/Apache timeout settings
- PHP-FPM process manager timeout
- Memory limits (`memory_limit`)
- Database connection timeouts

**Recommendation:**
Check server configuration files:
- `php.ini`: `max_execution_time`, `memory_limit`, `post_max_size`, `upload_max_filesize`
- Nginx: `fastcgi_read_timeout`, `proxy_read_timeout`
- PHP-FPM: `request_terminate_timeout`

---

### 11. **Database Connection Issues**

**Location:** `config/database.php`

**Potential Issues:**
- Database server overloaded
- Connection pool exhaustion
- Long-running queries blocking connections

**Recommendation:**
- Monitor database connection usage
- Implement connection pooling
- Add query timeouts
- Optimize slow queries

---

### 12. **Large File Uploads**

**Files:**
- Profile photo uploads
- Portfolio item uploads
- Progress tracker screenshot uploads

**Location:** 
- `routes/employee.php:68` - Portfolio uploads
- `routes/web.php:188` - Progress screenshot uploads
- Onboarding profile photo uploads

**Potential Issue:** Large files might cause:
- Request timeout
- Memory exhaustion
- Upload size limits exceeded

**Recommendation:**
- Implement chunked uploads
- Add client-side file size validation
- Process uploads asynchronously via queues
- Increase PHP upload limits if needed

---

## 📋 ACTION ITEMS CHECKLIST

### Immediate Actions (High Priority)
- [ ] Create `VerifyCsrfToken` middleware with proper configuration
- [ ] Add `credentials: 'same-origin'` to all `fetch()` calls making POST/PUT/DELETE requests
- [ ] Increase `SESSION_LIFETIME` from 120 to at least 480 minutes
- [ ] Verify session cookie configuration in `.env`
- [ ] Add `X-Requested-With: XMLHttpRequest` header to all fetch calls
- [ ] Improve 419 error handling to automatically reload page

### Short-term Actions (Medium Priority)
- [ ] Add credentials and headers to GET API calls that require authentication
- [ ] Implement session refresh mechanism on user activity
- [ ] Add localStorage backup for form data before page reloads
- [ ] Review and optimize file upload handlers
- [ ] Add request timeout handling on frontend

### Long-term Actions (Low Priority)
- [ ] Implement client-side CSRF token refresh mechanism
- [ ] Move heavy operations to background queues
- [ ] Add comprehensive error logging for 419/502 errors
- [ ] Implement retry logic for failed requests
- [ ] Add monitoring/alerting for error rates

---

## 🔍 TESTING RECOMMENDATIONS

1. **419 Error Testing:**
   - Test forms after session expires (wait 2+ hours)
   - Test with browser DevTools Network throttling
   - Test with cookies disabled/re-enabled
   - Test in incognito mode

2. **502 Error Testing:**
   - Test large file uploads (10MB+)
   - Test long-running operations
   - Monitor server logs during errors
   - Test with concurrent users

3. **Cross-Browser Testing:**
   - Test CSRF token handling in Chrome, Firefox, Safari
   - Verify cookie behavior across browsers
   - Test on mobile devices

---

## 📊 ERROR LOGGING RECOMMENDATIONS

Add comprehensive logging for debugging:

```php
// In bootstrap/app.php exception handler
$exceptions->render(function (\Illuminate\Session\TokenMismatchException $e, \Illuminate\Http\Request $request) {
    \Log::warning('CSRF Token Mismatch', [
        'url' => $request->fullUrl(),
        'method' => $request->method(),
        'user_id' => $request->user()?->id,
        'has_token' => $request->has('_token'),
        'has_header' => $request->hasHeader('X-CSRF-TOKEN'),
        'session_id' => $request->session()->getId(),
        'session_lifetime' => config('session.lifetime'),
    ]);
    
    // ... existing handler code
});
```

---

## 📚 REFERENCES

- [Laravel CSRF Protection Documentation](https://laravel.com/docs/11.x/csrf)
- [Laravel Session Configuration](https://laravel.com/docs/11.x/session)
- [Inertia.js CSRF Token Handling](https://inertiajs.com/csrf-protection)
- [MDN: Fetch API with Credentials](https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch#sending_a_request_with_credentials_included)

---

**Report Generated:** $(date)  
**Next Review:** After implementing high-priority fixes

